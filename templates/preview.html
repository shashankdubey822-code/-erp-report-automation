<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Preview - ERP Automator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container container-wide">
        <h1>Report Preview</h1>
        <p>Review your data below. The summary and chart are generated based on the initial data.</p>

        <form id="download-form" action="{{ url_for('download_file', filename=filename) }}" method="post" style="display: inline-block;">
            {% for key, value in metadata.items() %}
            <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endfor %}
            <button type="submit" class="download-btn">Download This Report as Excel</button>
        </form>

        <form id="download-pdf-form" action="{{ url_for('download_pdf', filename=filename) }}" method="post" style="display: inline-block;">
            {% for key, value in metadata.items() %}
            <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endfor %}
            <button type="submit" class="download-btn">Download This Report as PDF</button>
        </form>

        <a href="{{ url_for('view_file', filename=filename) }}" class="back-link">Go Back to Options</a>
        
        <div class="preview-section">
            <div id="table-container" class="table-container"></div>
        </div>

        <div class="summary-section">
            <h2>Summary</h2>
            <div id="summary-container">
                {{ summary_table | safe }}
            </div>
        </div>

        <div class="chart-section">
            <h2>Chart</h2>
            <div id="chart-container">
                <img id="chart-image" src="{{ chart_image }}" alt="Chart">
            </div>
        </div>
    </div>

    <script>
        const data = JSON.parse('{{ data_json | safe }}');
        const subject_details = JSON.parse('{{ subject_details | tojson | safe }}');
        const minAttendance = {{ metadata.min_attendance | default(75) }};

        const tableContainer = document.getElementById('table-container');

        function renderTable() {
            const table = document.createElement('table');
            table.className = 'preview-table';

            const thead = document.createElement('thead');
            const headerRow1 = document.createElement('tr');
            const headerRow2 = document.createElement('tr');
            const headerRow3 = document.createElement('tr');

            data.columns.forEach(col => {
                const th1 = document.createElement('th');
                const th2 = document.createElement('th');
                const th3 = document.createElement('th');

                if (subject_details[col]) {
                    th1.textContent = col;
                    th2.textContent = subject_details[col].code;
                    th3.textContent = subject_details[col].type;
                } else {
                    th1.textContent = col;
                    th2.textContent = '';
                    th3.textContent = '';
                }
                headerRow1.appendChild(th1);
                headerRow2.appendChild(th2);
                headerRow3.appendChild(th3);
            });

            thead.appendChild(headerRow1);
            thead.appendChild(headerRow2);
            thead.appendChild(headerRow3);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            data.data.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                row.forEach((cell, colIndex) => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    if (colIndex > 2 && colIndex < data.columns.length - 4) {
                        colorizeCell(td, cell);
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            tableContainer.innerHTML = '';
            tableContainer.appendChild(table);
        }

        function colorizeCell(cell, value) {
            const numericValue = parseFloat(value);
            if (!isNaN(numericValue)) {
                if (numericValue < minAttendance) {
                    cell.style.backgroundColor = '#ffcccc';
                } else {
                    cell.style.backgroundColor = '';
                }
            }
        }

        // Initial render
        renderTable();
    </script>
</body>
</html>