<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Preview - ERP Automator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container container-wide">
        <h1>Report Preview</h1>
        <p>Review your data below. You can edit the attendance values directly in the table. The summary and chart will update automatically.</p>

        <form id="download-form" action="{{ url_for('download_file', filename=filename) }}" method="post">
            {% for key, value in metadata.items() %}
            <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endfor %}
            <input type="hidden" name="subject_details" value='{{ subject_details_json | safe }}'>
            <button type="submit" class="download-btn">Download This Report as Excel</button>
        </form>

        <button id="refresh-btn" class="refresh-btn" style="display: none;">Refresh Chart and Summary</button>
        
        <a href="{{ url_for('view_file', filename=filename) }}" class="back-link">Go Back to Options</a>
        
        <div class="preview-section">
            <div id="table-container" class="table-container"></div>
        </div>

        <div class="summary-section">
            <h2>Summary</h2>
            <div id="summary-container"></div>
        </div>

        <div class="chart-section">
            <h2>Chart</h2>
            <div id="chart-container">
                <img id="chart-image" src="" alt="Chart">
            </div>
        </div>
    </div>

    <script>
        const data = JSON.parse('{{ data_json | safe }}');
        const subject_details = JSON.parse('{{ subject_details | tojson | safe }}');
        const filename = '{{ filename }}';
        const minAttendance = {{ metadata.min_attendance | default(75) }};

        const tableContainer = document.getElementById('table-container');
        const summaryContainer = document.getElementById('summary-container');
        const chartImage = document.getElementById('chart-image');

        function renderTable() {
            const table = document.createElement('table');
            table.className = 'preview-table';

            const thead = document.createElement('thead');
            const headerRow1 = document.createElement('tr');
            const headerRow2 = document.createElement('tr');
            const headerRow3 = document.createElement('tr');

            data.columns.forEach(col => {
                const th1 = document.createElement('th');
                const th2 = document.createElement('th');
                const th3 = document.createElement('th');

                if (subject_details[col]) {
                    th1.textContent = col;
                    th2.textContent = subject_details[col].code;
                    th3.textContent = subject_details[col].type;
                } else {
                    th1.textContent = col;
                    th2.textContent = '';
                    th3.textContent = '';
                }
                headerRow1.appendChild(th1);
                headerRow2.appendChild(th2);
                headerRow3.appendChild(th3);
            });

            thead.appendChild(headerRow1);
            thead.appendChild(headerRow2);
            thead.appendChild(headerRow3);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            data.data.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                row.forEach((cell, colIndex) => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    if (colIndex > 2 && colIndex < data.columns.length - 4) { // Assuming subject columns start from the 4th column
                        td.contentEditable = true;
                        td.addEventListener('blur', () => handleCellEdit(rowIndex, colIndex, td.textContent));
                        colorizeCell(td, cell);
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            tableContainer.innerHTML = '';
            tableContainer.appendChild(table);
        }

        function colorizeCell(cell, value) {
            const numericValue = parseFloat(value);
            if (!isNaN(numericValue)) {
                if (numericValue < minAttendance) {
                    cell.style.backgroundColor = '#ffcccc';
                } else {
                    cell.style.backgroundColor = '';
                }
            }
        }

        function handleCellEdit(rowIndex, colIndex, newValue) {
            data.data[rowIndex][colIndex] = newValue;
            colorizeCell(document.querySelector(`.preview-table tbody tr:nth-child(${rowIndex + 1}) td:nth-child(${colIndex + 1})`), newValue);
            document.getElementById('refresh-btn').style.display = 'block';
        }

        document.getElementById('refresh-btn').addEventListener('click', () => {
            updateAll();
            document.getElementById('refresh-btn').style.display = 'none';
        });

        async function updateAll() {
            const response = await fetch(`/api/update_data/${filename}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ data: data, min_attendance: minAttendance })
            });

            const result = await response.json();

            if (result.summary_table) {
                summaryContainer.innerHTML = result.summary_table;
            }
            if (result.chart_image) {
                chartImage.src = result.chart_image;
            }
        }

        document.getElementById('download-form').addEventListener('submit', (event) => {
            const hiddenDataInput = document.createElement('input');
            hiddenDataInput.type = 'hidden';
            hiddenDataInput.name = 'updated_data';
            hiddenDataInput.value = JSON.stringify(data);
            event.target.appendChild(hiddenDataInput);
        });

        // Initial render
        renderTable();
        updateAll();
    </script>
</body>
</html>