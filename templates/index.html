<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Report Automator - Smart Attendance Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
</head>
<body>
    <div class="container">
        <div class="header-section">
            <div class="logo-section">
                <div class="logo">üìä</div>
                <h1 class="app-title">Smart Attendance Analysis</h1>
                <a href="/chart" class="app-subtitle">View Chart</a>
                <p class="app-subtitle">Transform your attendance data into professional reports</p>
            </div>
            <div class="welcome-header">
                <h2 id="greeting">Welcome!</h2>
                <p id="quote">Loading a quote for you...</p>
            </div>
        </div>
        
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="flash-messages">
                    {% for message in messages %}
                        <div class="flash-message error">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="features-section">
            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <h3>Smart Analysis</h3>
                    <p>Automatically analyzes attendance patterns and identifies at-risk students</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìù</div>
                    <h3>Professional Reports</h3>
                    <p>Generates Excel reports with charts, summaries, and conditional formatting</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">‚ö°</div>
                    <h3>Quick Processing</h3>
                    <p>Processes hundreds of student records in seconds with error handling</p>
                </div>
            </div>
        </div>

        <div class="upload-section">
            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="upload-header">
                    <h3>üöÄ Get Started</h3>
                    <p>Upload your ERP attendance data file to begin analysis</p>
                </div>
                
                <div class="file-upload-area">
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">üìÑ</div>
                        <p class="upload-text">Drag & drop your file here or <span class="browse-text">browse</span></p>
                        <p class="upload-hint">Supports CSV files up to 16MB</p>
                        <input type="file" id="erp_file" name="erp_file" accept=".csv" required style="display: none;">
                    </div>
                    <div class="file-info is-hidden" id="fileInfo">
                        <span class="file-name" id="fileName"></span>
                        <button type="button" class="remove-file" id="removeFile">√ó</button>
                    </div>
                </div>
                
                <button type="submit" class="upload-btn" id="submitBtn" disabled>
                    <span class="btn-text">Upload and Continue</span>
                    <span class="btn-icon">‚Üí</span>
                    <div class="spinner"></div>
                </button>
                <div class="progress-bar-container is-hidden" id="progressBarContainer">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </form>
        </div>

        <!-- ‚úÖ Developer Credit Section -->
        <footer class="footer-section">
            <p class="developer-credit">
                Developed by <strong>Shashank Dubey</strong> and <strong>Vineet Kumar</strong><br>
                Under the guidance of <strong>Dr. Mamta Arora</strong><br>
                For the purpose of <strong>Manav Rachna University</strong>
            </p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Time-based Greeting
            const greetingEl = document.getElementById('greeting');
            const hour = new Date().getHours();
            if (hour < 12) {
                greetingEl.textContent = 'Good Morning! üåÖ';
            } else if (hour < 18) {
                greetingEl.textContent = 'Good Afternoon! ‚òÄÔ∏è';
            } else {
                greetingEl.textContent = 'Good Evening! üåÜ';
            }

            // Random Motivational Quote
            const quoteEl = document.getElementById('quote');
            const quotes = [
                "The secret of getting ahead is getting started.",
                "Efficiency is doing things right; effectiveness is doing the right things.",
                "Data is the new oil. Let's refine it into insights.",
                "Automation is good, so long as you know exactly where to put the machine.",
                "Your limitation‚Äîit's only your imagination.",
                "Great reports tell stories that inspire action."
            ];
            quoteEl.textContent = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;

            // Enhanced file upload functionality
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('erp_file');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const removeFile = document.getElementById('removeFile');
            const submitBtn = document.getElementById('submitBtn');
            const browseText = document.querySelector('.browse-text');

            // Click to browse files
            uploadZone.addEventListener('click', () => fileInput.click());
            browseText.addEventListener('click', (e) => {
                e.stopPropagation();
                fileInput.click();
            });

            // Drag and drop functionality
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-over');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('drag-over');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelection(files[0]);
                }
            });

            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelection(e.target.files[0]);
                }
            });

            // Handle file selection
            function handleFileSelection(file) {
                if (file.type !== 'text/csv' && !file.name.toLowerCase().endsWith('.csv')) {
                    alert('Please select a CSV file.');
                    return;
                }
                
                if (file.size > 16 * 1024 * 1024) {
                    alert('File size must be less than 16MB.');
                    return;
                }

                fileName.textContent = file.name;
                uploadZone.classList.add('is-hidden');
                fileInfo.classList.remove('is-hidden');
                submitBtn.disabled = false;
            }

            // Remove file
            removeFile.addEventListener('click', () => {
                fileInput.value = '';
                uploadZone.classList.remove('is-hidden');
                fileInfo.classList.add('is-hidden');
                submitBtn.disabled = true;
            });

            // Staggered fade-in for sections
            const sections = document.querySelectorAll('.header-section, .features-section, .upload-section, .footer-section');
            sections.forEach((section, index) => {
                setTimeout(() => {
                    section.style.opacity = '1';
                    section.style.transform = 'translateY(0)';
                }, (index * 150) + 100); // Stagger delay
            });

            // Form submission listener for progress bar
            const uploadForm = document.querySelector('.upload-form');
            uploadForm.addEventListener('submit', (e) => {
                e.preventDefault(); // Prevent default form submission

                const submitBtn = document.getElementById('submitBtn');
                const progressBarContainer = document.getElementById('progressBarContainer');
                const progressBar = document.getElementById('progressBar');
                const fileInput = document.getElementById('erp_file');
                const file = fileInput.files[0];

                if (!file) return;

                // Show spinner and disable button
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;

                // Show progress bar
                progressBarContainer.classList.remove('is-hidden');
                progressBar.style.width = '0%';

                const formData = new FormData();
                formData.append('erp_file', file);

                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/upload', true);

                // Listen for progress events
                xhr.upload.addEventListener('progress', (event) => {
                    if (event.lengthComputable) {
                        const percentComplete = (event.loaded / event.total) * 100;
                        progressBar.style.width = percentComplete + '%';
                    }
                });

                // Handle completion
                xhr.addEventListener('load', () => {
                    progressBar.style.width = '100%';
                    // Check if the response is a redirect
                    if (xhr.responseURL && xhr.responseURL !== window.location.href) {
                        window.location.href = xhr.responseURL;
                    } else {
                        // Handle cases where there might be an error message on the same page
                        // This part may need adjustment based on server-side error handling
                        document.body.innerHTML = xhr.responseText;
                    }
                });

                // Handle errors
                xhr.addEventListener('error', () => {
                    alert('An error occurred during the file upload.');
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                    progressBarContainer.classList.add('is-hidden');
                });

                xhr.send(formData);
            });
        });
    </script>

    <style>
        .footer-section {
            text-align: center;
            margin-top: 50px;
            padding: 20px 0;
            font-size: 0.95rem;
            color: #555;
            border-top: 1px solid #ddd;
        }

        .developer-credit strong {
            color: #2a4d8f;
        }

        .fade-in-up {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }
    </style>
</body>
</html>
